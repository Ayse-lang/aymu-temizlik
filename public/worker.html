<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aymu Cleaning</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background-image: url("https://scontent.fecn1-1.fna.fbcdn.net/v/t1.6435-9/118539772_722496224965797_5301967105800599601_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=833d8c&_nc_ohc=eOcry0XRdeYQ7kNvwHzqr4t&_nc_oc=AdludW8N1bnYEYd9jfiyrGo4n5YQu2DB5-i7nBkcydlVZdjb7DipCeBnp_pjHgqGQpY&_nc_zt=23&_nc_ht=scontent.fecn1-1.fna&_nc_gid=LJ1Q9rNpl_xxLD8O6-zmdQ&oh=00_AfjdJeQDN4vayfL41OfxCLk8F6jHcAbZQ26F-XfGnDBJGA&oe=6953A84A");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            min-height: 100vh;
        }

            /* Blur + karartma */
            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                backdrop-filter: blur(10px);
                background: rgba(0, 0, 0, 0.35);
                z-index: 0;
            }

        .admin-link {
            position: absolute;
            top: 40px;
            left: 20px;
            z-index: 50;
            padding: 6px 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(8px);
            text-decoration: none;
            transition: 0.2s;
        }

            .admin-link:hover {
                background: rgba(255, 255, 255, 0.45);
            }

        .container {
            position: relative;
            z-index: 2;
            width: 90%;
            max-width: 420px;
            margin: 60px auto;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
        }

        .top-logo {
            width: 150px; /* Slightly increased size */
            display: block;
            margin: 0 auto 20px auto; /* Centered and added more spacing below */
        }

        /* Added styles for logo-wrap and logo-text */
        .logo-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
            color: #d32f2f;
            background: rgba(255,255,255,0.95);
            padding: 4px 10px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        h2 {
            text-align: center;
            color: #d32f2f;
            margin: 10px 0 20px 0;
        }

        label {
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            font-size: 15px;
            margin-top: 5px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #f7f7f7;
            box-sizing: border-box;
        }

        textarea {
            height: 80px;
            resize: none;
        }

        /* Signature box */
        .signatureBox {
            width: 100%;
            height: 160px;
            border: 1px dashed #555;
            border-radius: 12px;
            background: white;
            margin-top: 10px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        #signaturePad {
            touch-action: none;
        }

        #clearSignature {
            background: #e53935;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Tenant not at home row */
        .tenantRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 10px;
        }

            .tenantRow label {
                margin: 0;
                font-weight: 600;
            }

            .tenantRow input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

        #sendBtn {
            width: 100%;
            padding: 14px;
            background: #d32f2f;
            border: none;
            color: white;
            margin-top: 15px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
        }

            #sendBtn:hover {
                background: #b71c1c;
            }

        #msg {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        #photoLabel {
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <a class="admin-link" href="login.html">üîê Admin</a>

    <div class="container">

        <div class="logo-wrap">
            <img class="top-logo" src="/logo.png" alt="Aymu Logo" />
            <span class="logo-text">Aymu Yurtlarƒ±</span>
        </div>

        <h2>Aymu Cleaning</h2>


        <!-- Cleaner -->
        <label>Cleaner (‡§∏‡§´‡§æ ‡§ó‡§∞‡•ç‡§®‡•á)</label>
        <select id="cleanerName">
            <option>Sukra</option>
            <option>Kancchi</option>
            <option>Binita</option>
        </select>

        <!-- Block -->
        <label>Block (‡§¨‡•ç‡§≤‡§ï)</label>
        <select id="block">
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>H</option>
            <option>I</option>
            <option>J</option>
        </select>

        <!-- Flat Number -->
        <label>Flat No (‡§´‡•ç‡§≤‡•ç‡§Ø‡§æ‡§ü ‡§®‡§Æ‡•ç‡§¨‡§∞)</label>
        <input type="text" id="apartmentNumber" />

        <!-- Date -->
        <label>Date (‡§Æ‡§ø‡§§‡§ø)</label>
        <input type="date" id="cleaningDate" />

        <!-- Time -->
        <label>Time (‡§∏‡§Æ‡§Ø)</label>
        <input type="time" id="cleaningTime" />

        <!-- Status -->
        <label>Status (‡§∏‡•ç‡§•‡§ø‡§§‡§ø)</label>
        <select id="status">
            <option value="normal">Normal (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø)</option>
            <option value="medium">A bit dirty (‡§Ö‡§≤‡§ø ‡§´‡•ã‡§π‡•ã‡§∞)</option>
            <option value="very_dirty">Very dirty (‡§ß‡•á‡§∞‡•à ‡§´‡•ã‡§π‡•ã‡§∞)</option>
        </select>

        <!-- Cleaning Request -->
        <label>Cleaning request (‡§∏‡§´‡§æ‡§à ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß)</label>
        <select id="cleaningRequest">
            <option value="requested">Requested (‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡§ø‡§Ø‡•ã)</option>
            <option value="not_requested">Not requested (‡§Ö‡§µ‡§æ‡§Ç‡§õ‡§ø‡§§)</option>
        </select>

        <!-- Note -->
        <label>Note (‡§®‡•ã‡§ü)</label>
        <textarea id="notes"></textarea>

        <!-- Tenant Not Home -->
        <div class="tenantRow">
            <label for="tenantNotHome">Tenant not at home (‡§ò‡§∞‡§Æ‡§æ ‡§®‡§≠‡§è‡§ï‡•ã)</label>
            <input type="checkbox" id="tenantNotHome" />
        </div>

        <!-- Signature -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <label style="margin:0;">Tenant signature (‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞)</label>
            <button id="clearSignature" type="button">Clear</button>
        </div>

        <div class="signatureBox">
            <canvas id="signaturePad"></canvas>
        </div>

        <!-- Photo (only Very Dirty) -->
        <label id="photoLabel">Photos (only if very dirty)</label>
        <input type="file" id="photos" multiple accept="image/*" />

        <!-- Save Button -->
        <button id="sendBtn" type="button">Save (‡§¨‡§ö‡§§ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç)</button>
        <p id="msg"></p>

        <!-- Job Finished Button -->
        <button id="jobFinishedBtn"
                type="button"
                style="width: 100%; padding: 14px; background: #4CAF50; border: none; color: white; margin-top: 15px; font-size: 18px; border-radius: 12px; cursor: pointer;">
            Job Finished
        </button>
    </div>

    <script>
        // Elementleri √ßekelim
        const cleanerName = document.getElementById("cleanerName");
        const block = document.getElementById("block");
        const apartmentNo = document.getElementById("apartmentNumber");
        const cleaningDate = document.getElementById("cleaningDate");
        const cleaningTime = document.getElementById("cleaningTime");
        const statusField = document.getElementById("status");
        const notes = document.getElementById("notes");
        const tenantNotHome = document.getElementById("tenantNotHome");
        const photosInput = document.getElementById("photos");
        const photoLabel = document.getElementById("photoLabel");
        const msg = document.getElementById("msg");

        // ‚úÖ NEW: temizlik istendi mi?
        const cleaningRequest = document.getElementById("cleaningRequest");

        // Signature pad
        const canvas = document.getElementById("signaturePad");
        const ctx = canvas.getContext("2d");
        const signatureBox = document.querySelector(".signatureBox");
        const clearBtn = document.getElementById("clearSignature");

        // Canvas ger√ßek pixel boyutunu ayarla (retina dahil)
        function resizeCanvas() {
            const ratio = window.devicePixelRatio || 1;
            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            canvas.width = Math.floor(w * ratio);
            canvas.height = Math.floor(h * ratio);
            ctx.setTransform(ratio, 0, 0, ratio, 0, 0); // koordinatlar CSS px gibi kalsƒ±n
            ctx.lineWidth = 3;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        let drawing = false;
        let hasSignature = false;

        function getPos(evt) {
            const rect = canvas.getBoundingClientRect();
            // touch
            if (evt.touches && evt.touches[0]) {
                return {
                    x: evt.touches[0].clientX - rect.left,
                    y: evt.touches[0].clientY - rect.top
                };
            }
            // mouse
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function startDraw(e) {
            if (signatureBox.classList.contains("disabled")) return;
            drawing = true;
            const p = getPos(e);
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            hasSignature = true;
            e.preventDefault();
        }

        function moveDraw(e) {
            if (!drawing) return;
            if (signatureBox.classList.contains("disabled")) return;
            const p = getPos(e);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
            e.preventDefault();
        }

        function endDraw(e) {
            drawing = false;
            e.preventDefault();
        }

        // ‚úÖ Mouse events
        canvas.addEventListener("mousedown", startDraw);
        canvas.addEventListener("mousemove", moveDraw);
        window.addEventListener("mouseup", endDraw);

        // ‚úÖ Touch events (TELEFON ƒ∞√áƒ∞N ≈ûART)
        canvas.addEventListener("touchstart", startDraw, { passive: false });
        canvas.addEventListener("touchmove", moveDraw, { passive: false });
        canvas.addEventListener("touchend", endDraw, { passive: false });

        clearBtn.onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            hasSignature = false;
        };

        // ‚úÖ ƒ∞mza alanƒ±nƒ± sadece "temizlik istenmedi" se√ßilince a√ß
        function updateSignatureVisibility() {
            const notRequested = cleaningRequest.value === "not_requested";

            if (notRequested) {
                signatureBox.style.display = "block";
                clearBtn.style.display = "inline-block";
            } else {
                signatureBox.style.display = "none";
                clearBtn.style.display = "none";
                // imza kapandƒ±ysa temizle
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                hasSignature = false;
            }
        }

        cleaningRequest.addEventListener("change", updateSignatureVisibility);

        // Tenant not at home ‚Üí imza alanƒ±nƒ± kilitle (ama sadece a√ßƒ±kken anlamlƒ±)
        tenantNotHome.addEventListener("change", () => {
            if (tenantNotHome.checked) {
                signatureBox.classList.add("disabled");
            } else {
                signatureBox.classList.remove("disabled");
            }
        });

        // Fotoƒüraf alanƒ±nƒ± sadece very_dirty i√ßin g√∂ster
        function updatePhotoVisibility() {
            if (statusField.value !== "very_dirty") {
                photosInput.style.display = "none";
                photoLabel.style.display = "none";
            } else {
                photosInput.style.display = "block";
                photoLabel.style.display = "block";
            }
        }
        statusField.addEventListener("change", updatePhotoVisibility);
        updatePhotoVisibility();

        // Tarih & saat otomatik doldur
        const now = new Date();
        cleaningDate.value = now.toISOString().slice(0, 10);
        cleaningTime.value = now.toTimeString().slice(0, 5);

        // ƒ∞lk a√ßƒ±lƒ±≈üta imzayƒ± kapat
        updateSignatureVisibility();

        // Formu g√∂nder
        document.getElementById("sendBtn").onclick = async () => {
            msg.textContent = "";

            if (!apartmentNo.value.trim()) {
                alert("Flat number is required.");
                return;
            }

            const notRequested = cleaningRequest.value === "not_requested";

            // ‚úÖ KURAL: sadece temizlik istenmediyse imza zorunlu
            if (notRequested && !tenantNotHome.checked && !hasSignature) {
                alert("Signature is required when cleaning is NOT requested.");
                return;
            }

            const fd = new FormData();
            fd.append("cleanerName", cleanerName.value);
            fd.append("block", block.value);
            fd.append("apartmentNumber", apartmentNo.value);
            fd.append("status", statusField.value);
            fd.append("notes", notes.value);
            fd.append("cleaningDate", cleaningDate.value);
            fd.append("cleaningTime", cleaningTime.value);
            fd.append("tenantNotHome", tenantNotHome.checked ? "true" : "false");

            // ‚úÖ yeni alan
            fd.append("cleaningRequest", cleaningRequest.value);

            let tenantSigned = "false";
            let tenantSignature = "";

            if (notRequested && !tenantNotHome.checked && hasSignature) {
                tenantSigned = "true";
                tenantSignature = canvas.toDataURL("image/png");
            }

            fd.append("tenantSigned", tenantSigned);
            fd.append("tenantSignature", tenantSignature);

            if (statusField.value === "very_dirty") {
                for (let f of photosInput.files) fd.append("photos", f);
            }

            try {
                const res = await fetch("/api/cleanings", { method: "POST", body: fd });
                const data = await res.json();

                if (data.success) {
                    msg.style.color = "green";
                    msg.textContent = "Saved successfully ‚úÖ";

                    apartmentNo.value = "";
                    notes.value = "";
                    tenantNotHome.checked = false;
                    signatureBox.classList.remove("disabled");
                    clearBtn.click();
                    photosInput.value = "";
                    statusField.value = "normal";
                    updatePhotoVisibility();

                    // reset cleaning request to requested
                    cleaningRequest.value = "requested";
                    updateSignatureVisibility();
                } else {
                    msg.style.color = "red";
                    msg.textContent = "Error: " + (data.error || "Unknown error");
                }
            } catch (e) {
                msg.style.color = "red";
                msg.textContent = "Server not reachable ‚ùå";
            }
        };

        // Job Finished
        document.getElementById("jobFinishedBtn").onclick = async () => {
            const cleaner = cleanerName.value;
            if (!cleaner) {
                alert("Cleaner name is required.");
                return;
            }

            try {
                const res = await fetch("/api/job-finished", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cleanerName: cleaner })
                });

                const data = await res.json();
                if (data.success) alert("Job marked as finished successfully ‚úÖ");
                else alert("Error: " + (data.error || "Unknown error"));
            } catch (e) {
                alert("Server not reachable ‚ùå");
            }
        };
    </script>
</body>
</html>
